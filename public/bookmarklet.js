/**
 * SpeedRead Bookmarklet
 *
 * This bookmarklet extracts article content from the current page
 * and sends it to SpeedRead via postMessage.
 *
 * How it works:
 * 1. Extracts title, content, and source from the page
 * 2. Opens SpeedRead with ?import=1 parameter
 * 3. Sends the article data via postMessage
 * 4. SpeedRead receives the data and adds the article
 *
 * To create the bookmarklet:
 * 1. Go to SpeedRead
 * 2. Navigate to Add Article > Bookmarklet tab
 * 3. Drag the button to your bookmarks bar
 *
 * The bookmarklet URL is dynamically generated by SpeedRead
 * to include the correct origin URL.
 */

(function() {
  // Extract title - try h1 first, fall back to document title
  const title = document.querySelector('h1')?.innerText || document.title;

  // Extract content - try common article containers
  const articleElement =
    document.querySelector('article') ||
    document.querySelector('[role="article"]') ||
    document.querySelector('.article-content') ||
    document.querySelector('.post-content') ||
    document.querySelector('main') ||
    document.body;

  const content = articleElement.innerText;

  // Extract source from hostname
  const source = location.hostname.replace('www.', '');

  // Create data object with type marker
  const data = {
    type: 'speedread-article',
    title: title,
    content: content,
    source: source,
    url: location.href
  };

  // SpeedRead URL - this gets replaced dynamically in the actual bookmarklet
  const SPEEDREAD_URL = 'http://localhost:5173';

  // Open SpeedRead
  const speedReadWindow = window.open(SPEEDREAD_URL + '?import=1', 'speedread');

  if (speedReadWindow) {
    // Send message multiple times to ensure delivery (page might still be loading)
    const sendData = () => speedReadWindow.postMessage(data, SPEEDREAD_URL);
    setTimeout(sendData, 1000);
    setTimeout(sendData, 2000);
    setTimeout(sendData, 3000);
  } else {
    alert('Could not open SpeedRead. Please check your popup blocker settings.');
  }
})();
